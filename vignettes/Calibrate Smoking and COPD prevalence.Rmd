---
title: "Calibrate smoking status and COPD prevalence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calibrating smoking status and prevalence of COPD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This document outlines the steps taken to calibrate the model to align with U.S.-based validation targets for smoking behavior and COPD prevalence using a 25 year time horizon.

Validation Targets:
COPD Prevalence: Tilert et al., 2013 (DOI: 10.1186/1465-9921-14-103)
Smoking Rates: Summary Health Statistics, National Health Interview Survey (NHIS), 2018

### Smoking calibration: Overview

This section outlines the steps taken to calibrate smoking behavior and COPD prevalence in the model to align with U.S.-based validation targets.

Smoking Behavior Validation Targets (NHIS 2018):

Current smokers: 13.8%
Former smokers: 20.9%
Never smokers: 65.3%

### Smoking calibration: Step 1- Modify intercept value to calibrate proportion of non-smokers and former smokeres in the model

EPIC's existing calibration function (from EPIC Canada) accurately matched the overall smoking rates from the 2018 Summary Health Statistics: National Health Interview Survey (NHIS), however, it underestimated the proportions of never and former smokers. To address this, we modified the intercept in the logistic regression equation that determines the probability of being a never smoker. Increasing the intercept to 4.85 improved alignment with the target distribution by increasing the proportion of former smokers.


```{r, eval = TRUE, echo = TRUE}
library(epicUS)
input_help$smoking$logit_p_never_smoker_con_not_current_0_betas <- "Probability of being a never-smoker conditional on not being current smoker, at the time of creation"
input$values$smoking$logit_p_never_smoker_con_not_current_0_betas<-t(as.matrix(c(intercept = 4.85, sex = 0, age = -0.06, age2 = 0,
                                                                                 sex_age = 0,sex_age2 = 0, year = -0.02)))
```

### Smoking calibration: Step 2- Create data tables 

```{r, eval = TRUE, echo = TRUE}
#Check smoking status
smokingstatus<- output$n_smoking_status_by_ctime
# Calculate total population of individuals at each year
row_sums <- rowSums(output$n_smoking_status_by_ctime)
# Convert to proportions
output$n_smoking_status_by_ctime_proportion <- output$n_smoking_status_by_ctime / row_sums
# Create dataframe
output$n_smoking_status_by_ctime_proportion <- as.data.frame(output$n_smoking_status_by_ctime_proportion)
# Add a model year column
output$n_smoking_status_by_ctime_proportion$Year <- 1:nrow(output$n_smoking_status_by_ctime_proportion)
# Reshape data
smokingstatus <- pivot_longer(output$n_smoking_status_by_ctime_proportion,
                        cols = c("V1", "V2", "V3"),
                        names_to = "Status",
                        values_to = "Proportion")
#Label data to prep for plotting
smokingstatus$Status <- recode(smokingstatus$SmokingStatus,
                                V1 = "Never Smoker",
                                V2 = "Current Smoker",
                                V3 = "Former Smoker")
```

### Smoking calibration: Step 3- Visualize data

```{r, eval = TRUE, echo = TRUE}

# Reshape data
smokingstatus <- pivot_longer(output$n_smoking_status_by_ctime_proportion,
                        cols = c("V1", "V2", "V3"),
                        names_to = "Status",
                        values_to = "Proportion")
#Label data to prep for plotting
smokingstatus$Status <- recode(smokingstatus$SmokingStatus,
                                V1 = "Never Smoker",
                                V2 = "Current Smoker",
                                V3 = "Former Smoker")

ggplot(smokingstatus, aes(x = Year, y = Proportion, color = Status)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Smoking Status Trends Over Time",
       x = "Year",
       y = "Proportion (%)",
       color = "Smoking Status") +
  theme_minimal()

```


### COPD prevalence: Overview

Validation Targets (Tilert et al., 2013, DOI: 10.1186/1465-9921-14-103):

Age specific prevalence:
Ages 40–59: 8.1%
Ages 60–79: 14.4%

Sex-specific prevalence: 
Males: 12.0%
Females: 8.6% 

To align with these targets, we updated the sex-specific intercepts in the logistic regression equations used to estimate COPD prevalence. The calibration focused on the age groups 40–59 and 60–79 years. Tilert et al. 2013 included only individuals aged 40 to 79, whereas the EPIC model simulates all individuals aged 40 and older. As a result, the overall sex-specific COPD prevalence in the model is expected to be slightly higher. Therefore, calibration focused on reproducing the male-to-female prevalence ratio reported in the validation study, which was approximately 1.4:1 (12.0% in males vs. 8.6% in females). The model was considered adequately calibrated if this ratio was preserved.

### COPD prevalence: Step 1- Modify intercept value to calibrate proportion of COPD prevalence by age group and sex  

The sex-specific intercepts were adjusted to match the age-specific prevalence targets (age groups: 40–59 and 60–79 years) while maintaining a 1.4:1 male-to-female ratio.

```{r, eval = TRUE, echo = TRUE}
input$values$COPD$logit_p_COPD_betas_by_sex <- cbind(male = c(intercept = -4.15189, age = 0.033070   , age2 = 0, pack_years = 0.025049   ,
                                                       current_smoking = 0, year = 0, asthma = 0),
                                              female = c(intercept = -4.28486, age = 0.027359   , age2 = 0, pack_years = 0.030399   ,
                                                         current_smoking = 0, year = 0, asthma = 0))
```


### COPD prevalence: Step 2- Create data tables by age category

```{r, eval = TRUE, echo = TRUE}

# Determine overall COPD prevalence

COPDprevalence_ctime_age<-output$n_COPD_by_ctime_age
COPDprevalence_ctime_age<-as.data.frame(output$n_COPD_by_ctime_age)
totalpopulation<-output$n_alive_by_ctime_age

# Prevalence by age 40-59 

alive_age_40to59 <- rowSums(output$n_alive_by_ctime_age[1:25, 40:59])
COPD_age_40to59 <-rowSums(output$n_COPD_by_ctime_age[1:25, 40:59])
prevalenceCOPD_age_40to59 <- COPD_age_40to59 / alive_age_40to59
print(prevalenceCOPD_age_40to59)

# Prevalence by age 60-79

alive_age_60to79 <- rowSums(output$n_alive_by_ctime_age[1:25, 60:79])
COPD_age_60to79 <-rowSums(output$n_COPD_by_ctime_age[1:25, 60:79])
prevalenceCOPD_age_60to79 <- COPD_age_60to79 / alive_age_60to79
print(prevalenceCOPD_age_60to79)
```

### COPD prevalence: Step 2- Visualize data by age category

```{r, eval = TRUE, echo = TRUE}

# Plot prevalence 40-59
plot_prevalence_40to59<- data.frame(
  Year = 1:25,
  Prevalence = prevalenceCOPD_age_40to59
)

ggplot(plot_prevalence_40to59, aes(x = Year, y = Prevalence)) +
  geom_line(size = 1.2, color = "blue") +
  geom_point(size = 2, color = "darkblue") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "COPD Prevalence Over Time (Age 40-59)",
    x = "Year",
    y = "Prevalence (%)"
  ) +
  theme_minimal()

plot_prevalence_60to79<- data.frame(
  Year = 1:25,
  Prevalence = prevalenceCOPD_age_60to79
)

ggplot(plot_prevalence_60to79, aes(x = Year, y = Prevalence)) +
  geom_line(size = 1.2, color = "blue") +
  geom_point(size = 2, color = "darkblue") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "COPD Prevalence Over Time (Age 60-79)",
    x = "Year",
    y = "Prevalence (%)"
  ) +
  theme_minimal()

```

### COPD prevalence: Step 3- Create data tables by sex

```{r, eval = TRUE, echo = TRUE}

alive_sex <- output$n_alive_by_ctime_sex
COPD_sex <- output$n_COPD_by_ctime_sex
prevalenceCOPD_sex <- COPD_sex / alive_sex
prevalenceCOPD_sex<-as.data.frame (prevalenceCOPD_sex)

```


### 
