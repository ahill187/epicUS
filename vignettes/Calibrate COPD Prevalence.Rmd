---
title: "Calibrate COPD Prevalence"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calibrate COPD Prevalence}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

### Overview

This document outlines the steps taken to calibrate the model to align with U.S.-based validation targets for COPD prevalence using a 25 year time horizon.
Validation Target: Tilert et al., 2013 (DOI: 10.1186/1465-9921-14-103)

Age specific prevalence:
Ages 40–59: 8.1%
Ages 60–79: 14.4%

Sex-specific prevalence: 
Males: 12.0%
Females: 8.6% 

To align with these targets, we updated the sex-specific intercepts in the logistic regression equations used to estimate COPD prevalence. The calibration focused on the age groups 40–59 and 60–79 years. Tilert et al. 2013 included only individuals aged 40 to 79, whereas the EPIC model simulates all individuals aged 40 and older. As a result, the overall sex-specific COPD prevalence in the model is expected to be slightly higher. Therefore, calibration focused on reproducing the male-to-female prevalence ratio reported in the validation study, which was approximately 1.4:1 (12.0% in males vs. 8.6% in females). The model was considered adequately calibrated if this ratio was preserved.

### Step 1: Load libraries and setup

Here, we load the necessary libraries. We also set the default simulation settings and specify the time horizon for the simulation (25 years).

```{r, eval = TRUE, echo = TRUE, message=FALSE}
library(epicUS)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(knitr)

# Load EPIC general settings
settings <- get_default_settings()
settings$record_mode <- 0
settings$n_base_agents <- 1e6
init_session(settings = settings)

input <- get_input()
time_horizon <- 26
input$values$global_parameters$time_horizon <- time_horizon

```

### Step 2: Modify intercept value to calibrate proportion of COPD prevalence by age group and sex  

The sex-specific intercepts were adjusted to match the age-specific prevalence targets (age groups: 40–59 and 60–79 years) while maintaining a 1.4:1 male-to-female ratio.

```{r, eval = TRUE, echo = TRUE}
input$values$COPD$logit_p_COPD_betas_by_sex <- cbind(male = c(intercept = -4.15189, age = 0.033070   , age2 = 0, pack_years = 0.025049   ,
                                                       current_smoking = 0, year = 0, asthma = 0),
                                              female = c(intercept = -4.28486, age = 0.027359   , age2 = 0, pack_years = 0.030399   ,
                                                         current_smoking = 0, year = 0, asthma = 0))

```

### Step 3: Run EPIC

```{r, eval = TRUE, echo = TRUE}

# Run EPIC simulation
run(input = input$values)
output <- Cget_output_ex()
terminate_session()

```

### Step 4: Create data tables by age category

```{r, eval = TRUE, echo = TRUE}

# Determine overall COPD prevalence

COPDprevalence_ctime_age<-output$n_COPD_by_ctime_age
COPDprevalence_ctime_age<-as.data.frame(output$n_COPD_by_ctime_age)
totalpopulation<-output$n_alive_by_ctime_age

# Prevalence by age 40-59 

alive_age_40to59 <- rowSums(output$n_alive_by_ctime_age[1:26, 40:59])
COPD_age_40to59 <-rowSums(output$n_COPD_by_ctime_age[1:26, 40:59])
prevalenceCOPD_age_40to59 <- COPD_age_40to59 / alive_age_40to59

# Prevalence by age 60-79

alive_age_60to79 <- rowSums(output$n_alive_by_ctime_age[1:26, 60:79])
COPD_age_60to79 <-rowSums(output$n_COPD_by_ctime_age[1:26, 60:79])
prevalenceCOPD_age_60to79 <- COPD_age_60to79 / alive_age_60to79

# Prevalence by age 80+

alive_age_over80 <- rowSums(output$n_alive_by_ctime_age[1:26, 80:111])
COPD_age_over80 <-rowSums(output$n_COPD_by_ctime_age[1:26, 80:111])
prevalenceCOPD_age_over80 <- COPD_age_over80 / alive_age_over80

# Display summary of COPD prevalence by age group 

COPD_prevalence_summary <- data.frame(
  Year = 2015:2040,
  Prevalence_40to59 = prevalenceCOPD_age_40to59,
  Prevalence_60to79 = prevalenceCOPD_age_60to79,
  Prevalence_over80 = prevalenceCOPD_age_over80
)

kable(COPD_prevalence_summary, 
      caption = "COPD Prevalence by Age Group Over Time",
      digits = 3)
```

### Step 5: Visualize data by age category

```{r plot_prevalence_40to59, fig.width = 8, fig.height = 6, echo = TRUE}

# Plot prevalence age 40-59
plot_prevalence_40to59<- data.frame(
  Year = 2015:2040,
  Prevalence = prevalenceCOPD_age_40to59
)

ggplot(plot_prevalence_40to59, aes(x = Year, y = Prevalence)) +
  geom_line(linewidth = 1.5, color = "#003f5c") +           # Deep navy
  geom_point(size = 3, color = "#66c2ff", stroke = 0.8) +   # Light blue
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, 0.10),
    breaks = seq(0, 0.10, by = 0.01)
  ) +
  scale_x_continuous(breaks = seq(2015, 2040, by = 5)) +
  labs(
    title = "COPD Prevalence Over Time (Age 40–59)",
    subtitle = "Estimated proportion of population with COPD from 2016–2040",
    x = "Year",
    y = "Prevalence (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5, margin = margin(b = 8)),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    axis.line = element_line(color = "black", linewidth = 0.8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

#Prevalence by age 60-79
alive_age_60to79 <- rowSums(output$n_alive_by_ctime_age[1:26, 60:79])
COPD_age_60to79 <-rowSums(output$n_COPD_by_ctime_age[1:26, 60:79])
prevalenceCOPD_age_60to79 <- COPD_age_60to79 / alive_age_60to79
print(prevalenceCOPD_age_60to79)

# Plot prevalence age 60-79
plot_prevalence_60to79<- data.frame(
  Year = 2015:2040,
  Prevalence = prevalenceCOPD_age_60to79
)

ggplot(plot_prevalence_60to79, aes(x = Year, y = Prevalence)) +
  geom_line(linewidth = 1.5, color = "#003f5c") +           # Deep navy
  geom_point(size = 3, color = "#66c2ff", stroke = 0.8) +   # Light blue
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, 0.20),
    breaks = seq(0, 0.20, by = 0.05)
  ) +
  scale_x_continuous(breaks = seq(2015, 2040, by = 5)) +
  labs(
    title = "COPD Prevalence Over Time (Age 60–79)",
    subtitle = "Estimated proportion of population with COPD from 2016–2040",
    x = "Year",
    y = "Prevalence (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5, margin = margin(b = 8)),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    axis.line = element_line(color = "black", linewidth = 0.8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

# Plot prevalence age 80+
plot_prevalence_over80<- data.frame(
  Year = 2015:2040,
  Prevalence = prevalenceCOPD_age_over80
)

ggplot(plot_prevalence_over80, aes(x = Year, y = Prevalence)) +
  geom_line(linewidth = 1.5, color = "#003f5c") +           # Deep navy
  geom_point(size = 3, color = "#66c2ff", stroke = 0.8) +   # Light blue
  scale_y_continuous(
    labels = scales::percent_format(accuracy = 1),
    limits = c(0, 0.30),
    breaks = seq(0, 0.30, by = 0.05)
  ) +
  scale_x_continuous(breaks = seq(2015, 2040, by = 5)) +
  labs(
    title = "COPD Prevalence Over Time (Age 80+)",
    subtitle = "Estimated proportion of population with COPD from 2016–2040",
    x = "Year",
    y = "Prevalence (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18, hjust = 0.5, margin = margin(b = 8)),
    plot.subtitle = element_text(size = 14, hjust = 0.5),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
    axis.line = element_line(color = "black", linewidth = 0.8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

```

### Step 6: Create data tables by sex to check if gender distribution matches Tilert et al 2013 (doi:10.1186/1465-9921-14-103))

```{r, eval = TRUE, echo = TRUE}

# Calculate COPD prevalence by sex over time

alive_sex <- output$n_alive_by_ctime_sex
COPD_sex <- output$n_COPD_by_ctime_sex
prevalenceCOPD_sex <- COPD_sex / alive_sex
prevalenceCOPD_sex<-as.data.frame (prevalenceCOPD_sex)

# Rename columns
colnames(prevalenceCOPD_sex) <- c("Male", "Female")
prevalenceCOPD_sex$Year <- 2015:2040


# Display summary of COPD prevalence by sex

kable(
  head(prevalenceCOPD_sex),
  caption = "COPD Prevalence by Sex Over Time",
  digits = 3
)
```


### 
